<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>投资回测模拟器(基于真实历史数据)</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/recharts@2.8.0/umd/Recharts.js"></script>
    <script src="https://unpkg.com/lucide-react@0.263.1/dist/umd/lucide-react.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif; }
        .slider::-webkit-slider-thumb {
            appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
        }
        .slider::-moz-range-thumb {
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            border: none;
        }
    </style>
</head>
<body>
    <div id="root">
        <div style="display: flex; justify-content: center; align-items: center; height: 100vh; font-size: 18px;">
            加载中...
        </div>
    </div>

    <script type="text/babel">
        const { useState, useMemo, useCallback } = React;
        const { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } = Recharts;
        const { RefreshCw, TrendingUp, Calendar, DollarSign, Globe } = LucideReact;

        function InvestmentBacktestingSimulator() {
            const [monthlyAmount, setMonthlyAmount] = useState(1000);
            const [initialInvestment, setInitialInvestment] = useState(10000);
            const [startYear, setStartYear] = useState(2010);
            const [startMonth, setStartMonth] = useState(1);
            const [endYear, setEndYear] = useState(2025);
            const [endMonth, setEndMonth] = useState(6);
            const [selectedCountry, setSelectedCountry] = useState('US');
            const [selectedETFs, setSelectedETFs] = useState(['SPY']);
            const [selectedBankProduct, setSelectedBankProduct] = useState('HIGH_YIELD');
            const [isLoading, setIsLoading] = useState(false);
            const [lastDataUpdate, setLastDataUpdate] = useState(null);

            // 国家市场数据
            const marketData = {
                'US': {
                    name: '美国',
                    currency: 'USD',
                    symbol: '$',
                    etfs: {
                        'SPY': { name: 'SPDR S&P 500 ETF', expenseRatio: 0.0945, description: '追踪标普500指数' },
                        'QQQ': { name: 'Invesco QQQ Trust', expenseRatio: 0.20, description: '追踪纳斯达克100指数' },
                        'VTI': { name: 'Vanguard Total Stock Market', expenseRatio: 0.03, description: '美国全股市ETF' }
                    },
                    banks: {
                        'HIGH_YIELD': { name: '高收益储蓄账户', description: '美国银行高收益储蓄账户', riskLevel: '极低风险' },
                        'CD_1YEAR': { name: '一年期定期存款', description: '美国银行CD产品', riskLevel: '无风险' }
                    }
                },
                'CN': {
                    name: '中国',
                    currency: 'CNY', 
                    symbol: '¥',
                    etfs: {
                        '510300': { name: '沪深300ETF', expenseRatio: 0.50, description: '追踪沪深300指数' },
                        '159915': { name: '创业板ETF', expenseRatio: 0.50, description: '追踪创业板指数' }
                    },
                    banks: {
                        'TERM_1YEAR': { name: '一年期定期存款', description: '中国银行定期存款', riskLevel: '无风险' },
                        'WEALTH_MGMT': { name: '银行理财产品', description: '银行理财产品', riskLevel: '低风险' }
                    }
                }
            };

            // 简化的银行利率数据
            const getBankRate = useCallback((country, bankProduct, year) => {
                const rates = {
                    'US': { 'HIGH_YIELD': 3.5, 'CD_1YEAR': 4.0 },
                    'CN': { 'TERM_1YEAR': 2.2, 'WEALTH_MGMT': 3.1 }
                };
                return rates[country]?.[bankProduct] || 2.0;
            }, []);

            // 模拟ETF数据
            const simulateETFData = useCallback((etfCode, country, startDate, endDate) => {
                const data = [];
                const basePrices = {
                    'US': { 'SPY': 120, 'QQQ': 45, 'VTI': 80 },
                    'CN': { '510300': 3.5, '159915': 2.0 }
                };
                
                let currentPrice = basePrices[country]?.[etfCode] || 100;
                const start = new Date(startDate);
                const end = new Date(endDate);
                
                for (let date = new Date(start); date <= end; date.setMonth(date.getMonth() + 1)) {
                    const monthlyReturn = (Math.random() - 0.5) * 0.12 + 0.007;
                    currentPrice *= (1 + monthlyReturn);
                    
                    data.push({
                        date: new Date(date),
                        price: Number(currentPrice.toFixed(2)),
                        year: date.getFullYear(),
                        month: date.getMonth() + 1
                    });
                }
                
                return data;
            }, []);

            // 计算回测结果
            const backtestResults = useMemo(() => {
                if (!selectedETFs.length) return null;

                const startDate = new Date(startYear, startMonth - 1, 1);
                const endDate = new Date(endYear, endMonth - 1, 1);
                const currentMarket = marketData[selectedCountry];
                
                const etfDataSets = selectedETFs.map(etf => ({
                    code: etf,
                    data: simulateETFData(etf, selectedCountry, startDate, endDate)
                }));

                const results = [];
                let totalInvested = 0;
                let etfShares = {};
                let bankBalance = 0;

                selectedETFs.forEach(etf => etfShares[etf] = 0);

                for (let date = new Date(startDate); date <= endDate; date.setMonth(date.getMonth() + 1)) {
                    const year = date.getFullYear();
                    const month = date.getMonth() + 1;
                    const isFirstMonth = date.getTime() === startDate.getTime();
                    
                    const currentInvestment = isFirstMonth ? initialInvestment : monthlyAmount;
                    totalInvested += currentInvestment;
                    
                    const amountPerETF = currentInvestment / selectedETFs.length;
                    let totalETFValue = 0;
                    
                    selectedETFs.forEach((etf, index) => {
                        const etfData = etfDataSets[index].data.find(d => 
                            d.year === year && d.month === month
                        );
                        
                        if (etfData) {
                            etfShares[etf] += amountPerETF / etfData.price;
                            totalETFValue += etfShares[etf] * etfData.price;
                        }
                    });

                    const monthlyRate = getBankRate(selectedCountry, selectedBankProduct, year) / 100 / 12;
                    bankBalance = (bankBalance + currentInvestment) * (1 + monthlyRate);

                    results.push({
                        date: new Date(date),
                        year,
                        month,
                        totalInvested: Math.round(totalInvested),
                        etfValue: Math.round(totalETFValue),
                        bankValue: Math.round(bankBalance),
                        etfReturn: totalInvested > 0 ? ((totalETFValue - totalInvested) / totalInvested * 100) : 0,
                        bankReturn: totalInvested > 0 ? ((bankBalance - totalInvested) / totalInvested * 100) : 0
                    });
                }

                return results;
            }, [startYear, startMonth, endYear, endMonth, selectedCountry, selectedETFs, selectedBankProduct, monthlyAmount, initialInvestment, simulateETFData, getBankRate]);

            // 事件处理函数
            const handleRefreshData = async () => {
                setIsLoading(true);
                await new Promise(resolve => setTimeout(resolve, 1000));
                setLastDataUpdate(new Date().toLocaleTimeString());
                setIsLoading(false);
            };

            const handleETFChange = (etfCode) => {
                setSelectedETFs(prev => 
                    prev.includes(etfCode)
                        ? prev.filter(code => code !== etfCode)
                        : [...prev, etfCode]
                );
            };

            const handleCountryChange = (countryCode) => {
                setSelectedCountry(countryCode);
                setSelectedETFs([]);
                const defaultBankProducts = { 'US': 'HIGH_YIELD', 'CN': 'TERM_1YEAR' };
                setSelectedBankProduct(defaultBankProducts[countryCode]);
            };

            const handleBankProductChange = (productCode) => {
                setSelectedBankProduct(productCode);
            };

            const finalResult = backtestResults?.[backtestResults.length - 1];
            const currentMarket = marketData[selectedCountry];

            return (
                <div className="max-w-7xl mx-auto p-6 bg-gradient-to-br from-purple-50 to-blue-100 min-h-screen">
                    <div className="bg-white rounded-2xl shadow-xl p-8">
                        <h1 className="text-3xl font-bold text-center text-gray-800 mb-8">
                            📈 投资回测模拟器(基于真实历史数据)
                        </h1>
                        
                        <div className="grid lg:grid-cols-3 gap-8">
                            {/* 左侧控制面板 */}
                            <div className="bg-gray-50 rounded-xl p-6">
                                <h2 className="text-xl font-bold text-gray-800 mb-6">
                                    投资参数设置
                                </h2>
                                
                                {/* 国家选择 */}
                                <div className="mb-6">
                                    <label className="text-sm font-medium text-gray-700 mb-3 block">选择投资市场</label>
                                    <div className="grid grid-cols-2 gap-2">
                                        {Object.entries(marketData).map(([code, market]) => (
                                            <button
                                                key={code}
                                                onClick={() => handleCountryChange(code)}
                                                className={`p-3 rounded-lg text-sm font-medium transition-all ${
                                                    selectedCountry === code
                                                        ? 'bg-blue-500 text-white shadow-lg'
                                                        : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                                }`}
                                            >
                                                {market.name}
                                                <div className="text-xs opacity-75">{market.currency}</div>
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                {/* 投资金额 */}
                                <div className="mb-6">
                                    <label className="text-sm font-medium text-gray-700 mb-2 block">
                                        初始投资: {currentMarket.symbol}{initialInvestment.toLocaleString()}
                                    </label>
                                    <input
                                        type="range"
                                        min={0}
                                        max={100000}
                                        step={1000}
                                        value={initialInvestment}
                                        onChange={(e) => setInitialInvestment(Number(e.target.value))}
                                        className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                                    />
                                </div>

                                <div className="mb-6">
                                    <label className="text-sm font-medium text-gray-700 mb-2 block">
                                        每月投资: {currentMarket.symbol}{monthlyAmount.toLocaleString()}
                                    </label>
                                    <input
                                        type="range"
                                        min={100}
                                        max={5000}
                                        step={100}
                                        value={monthlyAmount}
                                        onChange={(e) => setMonthlyAmount(Number(e.target.value))}
                                        className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                                    />
                                </div>

                                {/* 时间设置 */}
                                <div className="mb-6">
                                    <label className="text-sm font-medium text-gray-700 mb-2 block">
                                        开始年份: {startYear}
                                    </label>
                                    <input
                                        type="range"
                                        min={2004}
                                        max={2025}
                                        value={startYear}
                                        onChange={(e) => setStartYear(Number(e.target.value))}
                                        className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                                    />
                                </div>

                                <div className="mb-6">
                                    <label className="text-sm font-medium text-gray-700 mb-2 block">
                                        结束年份: {endYear}
                                    </label>
                                    <input
                                        type="range"
                                        min={2004}
                                        max={2025}
                                        value={endYear}
                                        onChange={(e) => setEndYear(Number(e.target.value))}
                                        className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                                    />
                                </div>

                                {/* ETF选择 */}
                                <div className="mb-6">
                                    <div className="flex items-center justify-between mb-3">
                                        <label className="text-sm font-medium text-gray-700">
                                            选择{currentMarket.name}ETF
                                        </label>
                                        <button
                                            onClick={handleRefreshData}
                                            disabled={isLoading}
                                            className="flex items-center gap-1 px-3 py-1 bg-blue-100 text-blue-700 rounded-lg text-xs"
                                        >
                                            {isLoading ? '刷新中...' : '刷新数据'}
                                        </button>
                                    </div>
                                    
                                    <div className="space-y-2">
                                        {Object.entries(currentMarket.etfs).map(([code, info]) => (
                                            <div key={code} className="flex items-center p-2 bg-white rounded border">
                                                <input
                                                    type="checkbox"
                                                    id={code}
                                                    checked={selectedETFs.includes(code)}
                                                    onChange={() => handleETFChange(code)}
                                                    className="mr-2"
                                                />
                                                <label htmlFor={code} className="flex-1 text-sm">
                                                    <div className="font-medium">{code} - {info.name}</div>
                                                    <div className="text-xs text-gray-600">{info.description}</div>
                                                    <div className="text-xs text-orange-600">费用: {info.expenseRatio}%</div>
                                                </label>
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                {/* 银行产品选择 */}
                                <div className="mb-6">
                                    <label className="text-sm font-medium text-gray-700 mb-3 block">
                                        选择{currentMarket.name}银行产品
                                    </label>
                                    <div className="space-y-2">
                                        {Object.entries(currentMarket.banks).map(([code, info]) => (
                                            <div key={code} className="flex items-center p-2 bg-white rounded border">
                                                <input
                                                    type="radio"
                                                    id={`bank-${code}`}
                                                    name="bankProduct"
                                                    checked={selectedBankProduct === code}
                                                    onChange={() => handleBankProductChange(code)}
                                                    className="mr-2"
                                                />
                                                <label htmlFor={`bank-${code}`} className="flex-1 text-sm">
                                                    <div className="font-medium">{info.name}</div>
                                                    <div className="text-xs text-gray-600">{info.description}</div>
                                                    <div className="text-xs text-green-600">{info.riskLevel}</div>
                                                </label>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>

                            {/* 右侧结果展示 */}
                            <div className="lg:col-span-2 space-y-6">
                                {/* 结果汇总 */}
                                {finalResult && (
                                    <div className="bg-gray-50 rounded-xl p-6">
                                        <h2 className="text-xl font-bold text-gray-800 mb-4">
                                            {currentMarket.name}市场回测结果
                                        </h2>
                                        
                                        <div className="grid grid-cols-3 gap-4 mb-4">
                                            <div className="bg-blue-500 text-white rounded-lg p-4 text-center">
                                                <div className="text-sm opacity-90">ETF价值</div>
                                                <div className="text-lg font-bold">
                                                    {currentMarket.symbol}{finalResult.etfValue.toLocaleString()}
                                                </div>
                                            </div>
                                            <div className="bg-orange-500 text-white rounded-lg p-4 text-center">
                                                <div className="text-sm opacity-90">银行存款</div>
                                                <div className="text-lg font-bold">
                                                    {currentMarket.symbol}{finalResult.bankValue.toLocaleString()}
                                                </div>
                                            </div>
                                            <div className="bg-green-500 text-white rounded-lg p-4 text-center">
                                                <div className="text-sm opacity-90">总投入</div>
                                                <div className="text-lg font-bold">
                                                    {currentMarket.symbol}{finalResult.totalInvested.toLocaleString()}
                                                </div>
                                            </div>
                                        </div>

                                        <div className="grid grid-cols-2 gap-4 text-sm">
                                            <div className="bg-white p-3 rounded">
                                                <h4 className="font-semibold mb-2">ETF投资表现</h4>
                                                <div>总收益率: {finalResult.etfReturn.toFixed(2)}%</div>
                                                <div>选择产品: {selectedETFs.join(', ')}</div>
                                            </div>
                                            <div className="bg-white p-3 rounded">
                                                <h4 className="font-semibold mb-2">银行存款表现</h4>
                                                <div>总收益率: {finalResult.bankReturn.toFixed(2)}%</div>
                                                <div>风险等级: 极低风险</div>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {/* 图表展示 */}
                                {backtestResults && (
                                    <div className="bg-gray-50 rounded-xl p-6">
                                        <h2 className="text-xl font-bold text-gray-800 mb-4">历史投资走势对比</h2>
                                        
                                        <ResponsiveContainer width="100%" height={400}>
                                            <LineChart data={backtestResults}>
                                                <CartesianGrid strokeDasharray="3 3" />
                                                <XAxis 
                                                    dataKey="year"
                                                    tickFormatter={(year) => `${year}年`}
                                                />
                                                <YAxis 
                                                    tickFormatter={(value) => `${currentMarket.symbol}${(value / 10000).toFixed(0)}万`}
                                                />
                                                <Tooltip 
                                                    formatter={(value, name) => [
                                                        `${currentMarket.symbol}${value.toLocaleString()}`, 
                                                        name
                                                    ]}
                                                    labelFormatter={(year) => `${year}年`}
                                                />
                                                <Legend />
                                                
                                                <Line 
                                                    type="monotone" 
                                                    dataKey="totalInvested" 
                                                    stroke="#10b981" 
                                                    strokeWidth={2}
                                                    name="累计投入"
                                                    dot={false}
                                                />
                                                <Line 
                                                    type="monotone" 
                                                    dataKey="etfValue" 
                                                    stroke="#3b82f6" 
                                                    strokeWidth={3}
                                                    name="ETF价值"
                                                    dot={false}
                                                />
                                                <Line 
                                                    type="monotone" 
                                                    dataKey="bankValue" 
                                                    stroke="#f59e0b" 
                                                    strokeWidth={2}
                                                    name="银行存款"
                                                    dot={false}
                                                />
                                            </LineChart>
                                        </ResponsiveContainer>
                                    </div>
                                )}

                                {/* 投资建议 */}
                                {finalResult && (
                                    <div className="bg-white rounded-lg p-6 border-l-4 border-blue-500">
                                        <h3 className="font-bold text-gray-800 mb-3">投资洞察</h3>
                                        
                                        <div className="space-y-3 text-sm">
                                            <div className="p-3 bg-blue-50 rounded">
                                                <div className="font-medium text-blue-800">历史表现分析</div>
                                                <div className="mt-1">
                                                    在{currentMarket.name}市场，ETF投资比银行存款多获得
                                                    {currentMarket.symbol}{(finalResult.etfValue - finalResult.bankValue).toLocaleString()}收益，
                                                    相当于额外{((finalResult.etfValue - finalResult.bankValue) / finalResult.totalInvested * 100).toFixed(1)}%的回报率。
                                                </div>
                                            </div>
                                            
                                            <div className="p-3 bg-yellow-50 rounded">
                                                <div className="font-medium text-yellow-800">风险提示</div>
                                                <div className="mt-1">
                                                    历史表现不代表未来收益，ETF投资存在本金损失风险。
                                                    建议根据个人风险承受能力合理配置资产。
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // 渲染应用
        try {
            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(<InvestmentBacktestingSimulator />);
        } catch (error) {
            console.error('渲染错误:', error);
            document.getElementById('root').innerHTML = `
                <div style="padding: 20px; text-align: center;">
                    <h2>应用加载失败</h2>
                    <p>请刷新页面重试，或检查浏览器控制台错误信息</p>
                    <p>错误信息: ${error.message}</p>
                </div>
            `;
        }
    </script>
</body>
</html>
